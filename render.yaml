services:
  # Web service (main app)
  - type: web
    name: aetherlms
    runtime: node
    buildCommand: rm -rf .next node_modules/.cache && npm ci --production=false && npm run build:safe
    startCommand: node server.js
    envVars:
      - key: PORT
        value: 3000
      - key: NODE_ENV
        value: production
      - key: SKIP_DB_CHECK
        value: "true"
      - key: BUILD_MODE
        value: "static"
      - key: CLEAR_BUILD_CACHE
        value: "true"
      - key: DATABASE_URL
        sync: false # Sensitive value, to be set in Render dashboard
      - key: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        sync: false # Sensitive value, to be set in Render dashboard
      - key: CLERK_SECRET_KEY
        sync: false # Sensitive value, to be set in Render dashboard
    # Auto-deploy on changes to main branch
    autoDeploy: true
    # Scale the service
    plan: standard
    # Health check path
    healthCheckPath: /api/healthcheck
    # Number of instances
    numInstances: 1
    # Startup script to ensure health check passes
    preDeployCommand: echo "Preparing for deployment" 